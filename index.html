<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Plugin Manager</title>
    <style>
        body { font-family: sans-serif; background: #222; color: #ccc; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #333; }
        th, td { padding: 10px; border: 1px solid #444; text-align: left; }
        th { background: #444; color: #fff; }

        .btn { padding: 5px 10px; cursor: pointer; border: none; color: white; border-radius: 3px; margin-right: 5px; }
        .btn-load { background: #28a745; }
        .btn-unload { background: #ffc107; color: #000; }
        .btn-del { background: #dc3545; }

        .status-active { color: #28a745; font-weight: bold; }
        .status-inactive { color: #777; font-style: italic; }
    </style>
</head>
<body>

<h2>Управление плагинами</h2>
<div id="status" style="height: 20px; color: #aaa;"></div>

<table>
    <thead>
    <tr>
        <th>Файл</th>
        <th>Команда</th>
        <th>Описание</th>
        <th>Статус</th>
        <th>Действия</th>
    </tr>
    </thead>
    <tbody id="list"></tbody>
</table>

<hr>
<h3>Загрузить новый (Компиляция)</h3>
<textarea id="code" style="width:100%; height:150px; background:#111; color:#0f0; border:1px solid #555;">
#include "api.h"
#include <string>
extern "C" EXPORT const char* get_name() { return "test"; }
extern "C" EXPORT const char* get_description() { return "New plugin"; }
extern "C" EXPORT const char* handle_message(const char* s, const char* t) { return "Works!"; }
</textarea>
<button onclick="compile()" style="margin-top:10px; padding:10px 20px;">Скомпилировать</button>

<script>
    function loadList() {
        fetch('/list').then(r => r.json()).then(data => {
            const list = document.getElementById('list');
            list.innerHTML = "";
            data.forEach(p => {
                let actions = "";

                if (p.status === 'active') {
                    // Если активен: Выключить | Удалить
                    actions += `<button class="btn btn-unload" onclick="doAction('unload', '${p.filename}', '${p.cmd}')">Выключить</button>`;
                    actions += `<button class="btn btn-del" onclick="doAction('delete', '${p.filename}', '${p.cmd}')">Удалить</button>`;
                } else {
                    // Если выключен: Включить | Удалить
                    actions += `<button class="btn btn-load" onclick="doAction('load', '${p.filename}', '')">Включить</button>`;
                    actions += `<button class="btn btn-del" onclick="doAction('delete', '${p.filename}', '')">Удалить</button>`;
                }

                const row = `<tr>
                    <td>${p.filename}</td>
                    <td>${p.cmd ? '#' + p.cmd : '-'}</td>
                    <td>${p.desc}</td>
                    <td class="status-${p.status}">${p.status.toUpperCase()}</td>
                    <td>${actions}</td>
                </tr>`;
                list.innerHTML += row;
            });
        });
    }

    function doAction(action, filename, cmd) {
        if(action === 'delete' && !confirm('Удалить файл навсегда?')) return;

        fetch('/manage', {
            method: 'POST',
            body: `action=${action}&file=${encodeURIComponent(filename)}&cmd=${encodeURIComponent(cmd)}`
        }).then(r => r.text()).then(msg => {
            document.getElementById('status').innerText = msg;
            loadList();
        });
    }

    function compile() {
        const code = document.getElementById('code').value;
        const fname = "plugin_" + Date.now();
        fetch('/compile', { method:'POST', body:`filename=${fname}&code=${encodeURIComponent(code)}` })
            .then(r => r.text())
            .then(msg => {
                document.getElementById('status').innerText = msg;
                loadList();
            });
    }

    loadList();
</script>

</body>
</html>